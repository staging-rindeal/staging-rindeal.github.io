name: Site Deployment and Testing

on:
  repository_dispatch:
    types: [ 'site-built' ]

jobs:
  'ARTIFACT':
    runs-on: ubuntu-latest
    steps:
    
    - name: 'Download artifact'
      id: 'DOWNLOAD'
      uses: actions-rindeal/download-artifact@v4
      with:
        'artifact':     ${{ github.event.client_payload['artifact'] }}
        'github-token': ${{ secrets['CODE_ARTIFACT_TOKEN'] }}

    - name: 'Upload artifact'
      id: 'UPLOAD'
      uses: actions-rindeal/upload-artifact@v4
      with:
        'name': ${{ fromJSON(github.event.client_payload['artifact'])['name'] }}

    outputs:
      'environment': ${{ github.event.client_payload['environment'] }}
      'artifact':    ${{ steps.UPLOAD.outputs.ARTIFACT }}

  'TESTS':
    needs: 'ARTIFACT'
    runs-on: ubuntu-latest
    steps:

    - name: 'Trigger tests'
      uses: peter-evans/repository-dispatch@v3
      with:
        'token': ${{ secrets['TESTER_DISPATCH_TOKEN'] }}
        'repository': ${{ vars['TESTER_REPO'] }}
        'event-type': 'test-site'
        'client-payload': ${{ toJSON(needs['ARTIFACT'].outputs) }}
